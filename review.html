<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Detections Review</title>
    <style>body{font-family:Arial;padding:1rem} img{max-width:200px;border:1px solid #ccc;margin-right:8px}</style>
  </head>
  <body>
    <h2>Review Detected Doors</h2>
    <div id="list">Loading...</div>
    <script>
      async function load(){
        const res = await fetch('/detections');
        const data = await res.json();
        const list = document.getElementById('list');
        list.innerHTML = '';
        for(const name of Object.keys(data)){
          const block = document.createElement('div');
          block.style.marginBottom = '1rem';
          const title = document.createElement('h3'); title.textContent = name;
          block.appendChild(title);
          const img = document.createElement('img');
          img.src = '/input/' + name + (data[name].image ? '' : '');
          img.alt = name;
          block.appendChild(img);
          const walls = data[name].walls || [];
          const form = document.createElement('form');
          form.dataset.image = name;
          walls.forEach((w, wi) => {
            const div = document.createElement('div');
            div.style.borderTop = '1px solid #eee'; div.style.paddingTop = '6px';
            const titleW = document.createElement('div'); titleW.textContent = 'Wall ' + wi + ' - doors: ' + (w.doors? w.doors.length:0);
            div.appendChild(titleW);
            (w.doors||[]).forEach((d, di) => {
              const id = 'chk_'+name+'_'+wi+'_'+di;
              const chk = document.createElement('input'); chk.type='checkbox'; chk.id=id; chk.checked = true;
              const lbl = document.createElement('label'); lbl.htmlFor = id; lbl.textContent = ' Accept door at ' + (d.center_px? d.center_px.join(',') : di);
              div.appendChild(chk); div.appendChild(lbl);
              div.appendChild(document.createElement('br'));
            });
            form.appendChild(div);
          });
          const save = document.createElement('button'); save.textContent='Save'; save.type='button';
          save.onclick = async ()=>{
            // read checkboxes and update data
            const boxes = form.querySelectorAll('input[type=checkbox]');
            let idx = 0;
            for(let wi=0; wi<walls.length; wi++){
              const w = walls[wi];
              if(!w.doors) continue;
              const kept = [];
              for(let di=0; di<w.doors.length; di++){
                const cb = form.querySelector('#chk_'+name+'_'+wi+'_'+di);
                if(cb && cb.checked){ kept.push(w.doors[di]); }
              }
              w.doors = kept;
            }
            const payload = { image: name, data: data[name] };
            await fetch('/detections/save', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
            alert('Saved');
            load();
          };
          block.appendChild(form);
          block.appendChild(save);
          list.appendChild(block);
        }
      }
      load();
    </script>
  </body>
</html>
